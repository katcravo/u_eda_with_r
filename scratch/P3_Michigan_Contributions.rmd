---
title: "2016 Campaign Contributions from Michigan"
author: "Kathleen Cravotta"
date: "November 19, 2016"
output: html_document
---

```{r setup, include=FALSE}
#{r echo=FALSE, message=FALSE, warning=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = 'C:/Users/Kathleen/Documents/Udacity/R/2016-MI')
```

## Contributions Data Set 

This exploratory data analysis covers 2016 presidential campaign contributions from residents of Michigan. The data is publicly available on the board of elections website.  

```{r Read data and add new variables}
contributions <- read.csv("2016-MI.csv", header=TRUE, sep = ",", row.names = NULL)
contributions$X <- NULL

cand_info <- read.csv("cand_nms.csv", header=TRUE, sep = ",", row.names = NULL)
library(ggplot2) 
library(gridExtra) 
library(dplyr)
library(GGally)
library(reshape2)

contributions$date <- as.Date(paste(contributions$contb_receipt_dt), format="%d-%b-%y")
contributions.combined <- merge(contributions, cand_info, by = "cand_nm", all.contributions = TRUE)
head(contributions)
```
```{r summary of input data}
#names(contributions)
#summary(contributions)
```

###Number of contributions per candidate
This graph illustrates that Clinton and Sanders had the highest numbers of contributions.

```{r contributions per candidate}
library(ggplot2)
ggplot(aes(x = cand_nm), data = contributions) + 
  geom_bar()+ theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Enriching the Data Set 

The gender and political party for each candidate was used to enrich the data set.  

```{r Read data and add new variables}
head(cand_info)
```

## Size of contribution vs. Number of contributions

This section aims to provide a visualization of the number of contributions.  By default, the majority of contributions are clustered at the low end of the graph, or less than $100.  

```{r contribution amounts}
ggplot(aes(x = contb_receipt_amt), data = contributions ) + 
  geom_histogram()+
  scale_x_continuous(limits = c(0, 500))

```

with bin width
```{r improve contribution amounts}
ggplot(aes(x = contb_receipt_amt), data = contributions) + 
  geom_histogram(binwidth = 25)+
  scale_x_continuous(limits = c(0, 1000), breaks = seq(0,1000,50))+
  scale_y_log10()
```

```{r contribution amounts transformations}
p_n = ggplot(aes(x = contb_receipt_amt), data = contributions) + 
  geom_histogram(binwidth = 100)+
  scale_y_log10()+
  scale_x_continuous(limits = c(-1000, 5000), breaks = seq(-500,5000,1000))
p_log10 = ggplot(aes(x = log10(contb_receipt_amt)), data = contributions) + 
  geom_histogram(binwidth = .1)+
  scale_x_continuous(limits = c(-1, 4), breaks = seq(-1,4,.5)) +
  scale_y_log10()
p_sqrt = ggplot(aes(x = sqrt(contb_receipt_amt)), data = contributions) + 
  geom_histogram(binwidth = 2)+
  scale_y_log10()+
  scale_x_continuous(limits = c(-10, 80), breaks = seq(0,80,10))
# arrange plots in grid
grid.arrange(p_n, p_log10, p_sqrt, ncol =1)

```


with facet
```{r Political Party number of contributions}

ggplot(aes(x= log10(contb_receipt_amt)), data = contributions.combined) + 
  geom_histogram(binwidth = .1)+
  scale_y_log10()+
  scale_x_continuous(limits = c(-1, 4), breaks = seq(-1,4,.5)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  facet_wrap(~pol_party)
```



```{r Candidates}
table(contributions$cand_nm)
by(contributions$contb_receipt_amt, contributions$cand_nm, summary)
```
Observation: people in the race for a short time have a higher contribution average.  Maybe early contributions are higher than later ones.  
The median is a good rep of the contributions. A 'long tail' on the data pulls up the mean.


Checking dates
```{r Contributions by Date}
#contributions$date <- as.Date(paste(contributions$contb_receipt_dt), format="%d-%b-%y")
#contributions
ggplot(aes(x = date), data = contributions) + 
   geom_histogram(binwidth = 7, color = 'black', fill = '#099DD9')+
   scale_x_date(limits = c(as.Date("2015-6-1"), NA))
```
```{r group by candidate}
cand_groups <- group_by(contributions,cand_nm)

contributions.by_cand <- summarise(cand_groups, 
          contrib_mean = mean(contb_receipt_amt),
          contrib_median = median(contb_receipt_amt),
          contrib_sum = sum(contb_receipt_amt),
          contrib_last = max(date),
          n = n())

head(contributions.by_cand)

```

```{r Plot }
set.seed(1836)
cont_subset <- contributions.combined[c("cand_nm", "contb_receipt_amt", "date", "pol_party", "gender")]
cand_remaining <- factor(subset(contributions.by_cand, contrib_last > as.Date('2016-07-01'))$cand_nm)
cont_subset_cand <- subset(cont_subset,cand_nm %in% cand_remaining )
cont_subset_cand$cand_nm <- factor (cont_subset_cand$cand_nm)
#names(cont_subset)
ggpairs(cont_subset_cand[sample.int(nrow(cont_subset),2000), ])
```
```{r contribution sum per candidate}
library(ggplot2)
ggplot(aes(x = cand_nm, y = contrib_sum), data = contributions.by_cand) + 
  geom_bar( stat="identity" )+ theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r Clinton and Trump Line}
hillndon = subset(contributions, cand_nm == "Clinton, Hillary Rodham"| cand_nm == "Trump, Donald J.")
#summary(hillndon)
hillndon$cand_nm <- factor (hillndon$cand_nm)

ggplot(aes(x = date), data = hillndon) + 
  geom_freqpoly(aes(color = cand_nm), binwidth=7) + 
  scale_x_date(limits = c(as.Date("2015-6-1"), NA))+ 
  xlab('Timeline') + 
  ylab('Number of donations')
```
{}

box plot
```{r Clinton and Trump Box Plot}
ggplot(aes(x = cand_nm, y = contb_receipt_amt), data = hillndon) + 
  geom_boxplot() +
  coord_cartesian(ylim = c(0, 250))
```
box plot
```{r summary Clinton and Trum amounts}
by(hillndon$contb_receipt_amt, hillndon$cand_nm, summary) 
```


```{r scatterplot of contributions over time}
ggplot(aes(x = date, y = contb_receipt_amt), data = contributions) + 
  geom_jitter(alpha = 1/25)+
  scale_y_log10()+
  scale_x_date(limits =  c(as.Date("2015-6-1"), NA))
```
```{r scatterplots of democrat and repulican contributions}
plot_date_dem <- ggplot(aes(x = date, y = contb_receipt_amt),
                        data = subset(contributions.combined, pol_party=="Democrat")) + 
  geom_point(color = 'blue', alpha = 1/25 ) +
  scale_x_date(limits =  c(as.Date("2015-6-1"), NA))+
  scale_y_sqrt(limits = c(NA, 2800))
plot_date_rep <- ggplot(aes(x = date, y = contb_receipt_amt),
                        data = subset(contributions.combined, pol_party=="Republican")) + 
  geom_point(color = 'red' , alpha = 1/25) +
  scale_x_date(limits =  c(as.Date("2015-6-1"), NA))+
  scale_y_sqrt(limits = c(NA, 2800))
grid.arrange(plot_date_dem, plot_date_rep, ncol=1)


```


```{r combine candidate info in summary}
cand_info.combined <- merge(contributions.by_cand,cand_info,by="cand_nm")
finals <- subset(contributions, date > as.Date("2016-10-15"))
#summary(finals)
cand_info.combined <- arrange(cand_info.combined, cand_nm)
head(cand_info.combined)
```


```{r group by date}
date_groups <- group_by(contributions,date)

contributions.by_date <- summarise(date_groups, 
          contrib_mean = mean(contb_receipt_amt),
          contrib_median = median(contb_receipt_amt),
          n = n())

```

```{r Average Contribution and Number of contributions over time}
plot_date_mean <- ggplot(aes(x = date, y = contrib_mean), data = contributions.by_date) + 
  geom_point() +
  scale_x_date(limits =  c(as.Date("2015-6-1"), NA))+
  scale_y_sqrt(limits = c(NA, 1500))
plot_date_count <- ggplot(aes(x = date, y = n), data = contributions.by_date) + 
  geom_point() +
  scale_x_date(limits =  c(as.Date("2015-6-1"), NA))+
  scale_y_sqrt()
grid.arrange(plot_date_mean, plot_date_count, ncol=1)


```

```{r correlation of date and amount}
cor.test(as.numeric(contributions$date),contributions$contb_receipt_amt,method = "pearson")
```


```{r contributions with average}
ggplot(aes(x = date, y = contb_receipt_amt), data = contributions) + 
  geom_jitter(alpha = 1/25, color = "orange")+
  scale_y_log10()+
  scale_x_date(limits =  c(as.Date("2015-6-1"), NA))+
  geom_line(stat="summary",fun.y=mean)
```


```{r 80 quantile}
ggplot(aes(x = date, y = contb_receipt_amt), data = contributions) + 
  geom_jitter(alpha = 1/25, color = "orange")+
  scale_y_log10()+
  scale_x_date(limits =  c(as.Date("2015-6-1"), NA))+
  #geom_line(stat="summary", fun.y=mean)+
  geom_line(stat="summary", fun.y=quantile, fun.args=list(probs=0.9), linetype=2, color="blue")+
  geom_line(stat="summary", fun.y=quantile, fun.args=list(probs=0.5), color="blue")
```



```{r group by city}
city_groups <- group_by(contributions,contbr_city)

contributions.by_city <- summarise(city_groups, 
          contrib_mean = mean(contb_receipt_amt),
          contrib_median = median(contb_receipt_amt),
          n = n())

head(contributions.by_city)

```


```{r group by date and political party}
contributions.by_date_party <- contributions.combined %>%
  group_by(date, pol_party) %>%
  summarise(mean_cont = mean(contb_receipt_amt),
            median_cont = median(contb_receipt_amt),
            sum_cont = sum(contb_receipt_amt),
            n = n()) %>%
  ungroup() %>%
  arrange(date)

#contributions.by_date_party
```

```{r scatterplot by date and political party}
ggplot(aes(x = date, y = sum_cont), data = contributions.by_date_party)+
  geom_point(aes(color=pol_party))+
  #geom_smooth(aes(color=pol_party))+
  scale_y_log10()+
  scale_x_date(limits =  c(as.Date("2015-6-1"), NA))
```


```{r date with columns for each political party sum}
dates <- unique(contributions.by_date_party$date)
contributions.by_date_for_party = data_frame(dates)
contributions.by_date_for_party$Republican <- 
  contributions.by_date_party$sum_cont[match(contributions.by_date_for_party$dates,
                                            (subset(contributions.by_date_party,pol_party=='Republican'))$date)]
contributions.by_date_for_party$Democrat <- 
  contributions.by_date_party$sum_cont[match(contributions.by_date_for_party$dates,
                                            (subset(contributions.by_date_party,pol_party=='Democrat'))$date)]
contributions.by_date_for_party$Green <- 
  contributions.by_date_party$sum_cont[match(contributions.by_date_for_party$dates,
                                            (subset(contributions.by_date_party,pol_party=='Green'))$date)]
contributions.by_date_for_party$Independent <- 
  contributions.by_date_party$sum_cont[match(contributions.by_date_for_party$dates,
                                            (subset(contributions.by_date_party,pol_party=='Independent'))$date)]
contributions.by_date_for_party$Libertarian <- 
  contributions.by_date_party$sum_cont[match(contributions.by_date_for_party$dates,
                                            (subset(contributions.by_date_party,pol_party=='Libertarian'))$date)]
contributions.by_date_for_party[is.na(contributions.by_date_for_party)] <- 0
```

```{r graph dem rep ratio of contribution amoutns over time}
ggplot(aes(x = dates, y = Democrat/Republican), data = contributions.by_date_for_party)+
  geom_line()+
  scale_y_log10()+
  scale_x_date(limits =  c(as.Date("2015-6-1"), NA))+
  geom_hline(yintercept = 1, alpha = 0.2, linetype = 2)+
  geom_smooth(span=.5)
```

```{r contributions in each bucket over time}
contributions$contb_receipt_amt.bucket <- cut (contributions$contb_receipt_amt, c(0, 25, 100, 1000, 2700))
summary(contributions$contb_receipt_amt.bucket)

ggplot(aes(x=date), data = subset(contributions, !is.na(contb_receipt_amt.bucket))) + 
  geom_freqpoly(aes(color = contb_receipt_amt.bucket))+
  scale_y_sqrt()+
  scale_x_date(limits =  c(as.Date("2015-6-1"), NA))
```

```{r group by date and candidate}

contributions.conts_by_date_cand <- contributions %>%
  group_by(date, cand_nm) %>%
  summarise(mean_cont = mean(contb_receipt_amt),
            median_cont = median(contb_receipt_amt),
            sum_cont = sum(contb_receipt_amt),
            n = n()) %>%
  ungroup() %>%
  arrange(date)

#head(contributions.conts_by_date_cand)

```

```{r facet wrap for contributions per candidate}
ggplot(aes(x=date, y = sum_cont), 
       data = subset(contributions.conts_by_date_cand, date>= as.Date('2014-9-1')) )+
         facet_wrap(~cand_nm) +
         geom_point(alpha = .25) + 
         scale_y_continuous(limits = c(NA, 100000))+ 
         theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

```{r get monthly totals per candidate}

contributions.combined.by_month_cand <- subset(contributions.combined, date >= as.Date('2014-9-1')) %>%
  group_by( month = strftime(date, "%Y/%m"), cand_nm, pol_party) %>%
  summarise(mean_cont = mean(contb_receipt_amt),
            median_cont = median(contb_receipt_amt),
            sum_cont = sum(contb_receipt_amt),
            n = n()) %>%
  ungroup() 

head(contributions.combined.by_month_cand)

```

```{r facet wrap monthly totals per candidate with color}
ggplot(aes(x=month, y = sum_cont), 
       data = contributions.combined.by_month_cand) +
         facet_wrap(~cand_nm) +
         geom_point(alpha = .5, aes(color = pol_party)) +
         scale_y_sqrt(breaks = c(3000,200000,750000))+ 
         scale_x_discrete(breaks = c('2015/01', '2015/07','2016/01', '2016/07'))+
         theme(axis.text.x = element_text(angle = 90, hjust = 1))+
         scale_colour_manual(name="",  
                      values = c("Republican"="Red", "Democrat"="Blue", "Green"="Green",
                                 "Libertarian"="Orange", "Independent"="Purple")) + 
         ggtitle("Monthly Contribution totals to candidate") +
         labs (x = "Months", y = "Total Contributions (Dollars)") 
  
         


```

```{r Clinton and Trump - Group by Date}
hillndon$cand_nm <- factor (hillndon$cand_nm)


hillndon.conts_by_date_cand <- hillndon %>%
#filter (cand_nm == 'Clinton, Hillary Rodham' | cand_nm == "Trump, Donald J.") %>%
  group_by(date, cand_nm) %>%
  summarise(mean_cont = mean(contb_receipt_amt),
            median_cont = median(contb_receipt_amt),
            sum_cont = sum(contb_receipt_amt),
            n = n()) %>%
  ungroup() %>%
  arrange(date)

#head(hillndon.conts_by_date_cand)
```

```{r Graph Clinton and Trump sums by date}
ggplot(aes(x = date, y = sum_cont), data = hillndon.conts_by_date_cand)+
  geom_line(aes(color= cand_nm) )+
  scale_color_discrete(name="Candidate")+
  geom_smooth(aes(color=cand_nm), span=.5)+
  scale_y_log10(breaks = c(100,1000,10000,100000), labels = c(100,1000,10000,100000))+
  ggtitle("Contributions by Date - Clinton and Trump") +
  labs (x = "Timeline", y = "Total Contributions (Dollars)") 
```


```{r group by city for ratio}
#Enhance this section.  Add a ratio for democratic & republican contributions (sum dem - sum rep)/(sum dem + sum rep) within each city.  Then make a gradient color on this parameter.  Use this parameter as the x axis, and create a scatter plot.  The y axis (sum dem +sum)

city_groups.combined <- group_by(contributions.combined,contbr_city)

contributions.by_city.ratio <- summarise(city_groups.combined, 
          contrib_mean = mean(contb_receipt_amt),
          contrib_median = median(contb_receipt_amt),
          contrib_sum = sum(contb_receipt_amt),
          sum_rep = sum(contb_receipt_amt[pol_party=="Republican"]),
          sum_dem = sum(contb_receipt_amt[pol_party=="Democrat"]),
          dem_rep_total = sum(contb_receipt_amt[pol_party=="Republican"]) + sum(contb_receipt_amt[pol_party=="Democrat"]),
          dem_rep_ratio = ((sum(contb_receipt_amt[pol_party=="Republican"])) - (sum(contb_receipt_amt[pol_party=="Democrat"]) ) ) / ((sum(contb_receipt_amt[pol_party=="Republican"])) + (sum(contb_receipt_amt[pol_party=="Democrat"]) )),
          #dem_rep_n_ratio = ((count(contb_receipt_amt[pol_party=="Republican"])) - (count(contb_receipt_amt[pol_party=="Democrat"]) ) ) / ((count(contb_receipt_amt[pol_party=="Republican"])) + (count(contb_receipt_amt[pol_party=="Democrat"]) )),
          n = n())


#head(contributions.by_city.ratio)

```
```{r Ratio of democratic vs. republican contribution amounts}

bottom_label <- paste(c(nrow(subset(contributions.by_city.ratio, dem_rep_ratio<0)),
                        "Cities |", 
                        nrow(subset(contributions.by_city.ratio, dem_rep_ratio>0)),
                        "Cities"),
                      collapse = " ")
                      
ggplot(aes(x = dem_rep_ratio, y = dem_rep_total, size = n, color = dem_rep_ratio), data = contributions.by_city.ratio) + 
  geom_jitter(alpha = 1/5)+
  scale_x_continuous(labels = c("Democrat", "Majority Dem", "Neutral", "Majority Rep", "Republican"))+
  scale_y_log10(breaks = c(0,10, 100, 1000,10000, 100000, 1000000), labels = c(0, 10,100, 1000,10000, 100000, 1000000) ) +
  coord_cartesian(xlim = c(-1.1, 1.1) ) +
  scale_size(name = "# Contrib")+
  scale_colour_gradient(low="Blue", high = "Red", guide = FALSE)+
  ggtitle("Contribution Amounts by City") +
  labs (x = bottom_label, y = "Total Contribution Amount") 
```

